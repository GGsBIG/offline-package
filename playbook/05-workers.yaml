---
- name: Join worker nodes to the Kubernetes cluster
  hosts: workers
  become: true
  vars:
    offline_dest_dir: /opt/offline-package
    package_dir: "{{ offline_dest_dir }}/k8s-package"
    kubernetes_node_archive: "{{ package_dir }}/kubernetes-node-linux-amd64.tar.gz"
  pre_tasks:
    - name: Obtain kubeadm join command from control plane
      ansible.builtin.command: kubeadm token create --print-join-command --ttl 0
      register: kubeadm_join
      run_once: true
      delegate_to: "{{ groups['masters'][0] }}"
      become: true

    - name: Share kubeadm join command with workers
      ansible.builtin.set_fact:
        kubeadm_join_command: "{{ kubeadm_join.stdout }}"
      run_once: true

  tasks:
    - name: Ensure kubeadm join command is available
      ansible.builtin.fail:
        msg: "Failed to retrieve kubeadm join command from control plane"
      when: kubeadm_join_command is not defined or kubeadm_join_command | length == 0

    - name: Extract Kubernetes node package
      ansible.builtin.unarchive:
        src: "{{ kubernetes_node_archive }}"
        dest: "{{ package_dir }}"
        remote_src: true
        creates: "{{ package_dir }}/kubernetes/node/bin/kubeadm"

    - name: Install Kubernetes node binaries
      ansible.builtin.copy:
        src: "{{ package_dir }}/kubernetes/node/bin/{{ item }}"
        dest: "/usr/bin/{{ item }}"
        mode: "0755"
        remote_src: true
      loop:
        - kubeadm
        - kubelet

    - name: Install kubelet systemd unit
      ansible.builtin.template:
        src: kubelet.service.j2
        dest: /etc/systemd/system/kubelet.service
        mode: "0644"

    - name: Ensure kubelet drop-in directory exists
      ansible.builtin.file:
        path: /etc/systemd/system/kubelet.service.d
        state: directory
        mode: "0755"

    - name: Install kubelet kubeadm drop-in
      ansible.builtin.template:
        src: 10-kubeadm.conf.j2
        dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
        mode: "0644"

    - name: Enable kubelet service
      ansible.builtin.systemd:
        name: kubelet
        enabled: true
        daemon_reload: true
        state: restarted

    - name: Join node to control plane
      ansible.builtin.command: "{{ kubeadm_join_command }} --ignore-preflight-errors=all"
      args:
        creates: /etc/kubernetes/kubelet.conf
      register: kubeadm_join_result

    - name: Report kubeadm join result
      ansible.builtin.debug:
        msg: "{{ kubeadm_join_result.stdout }}"
      when: kubeadm_join_result.stdout is defined and kubeadm_join_result.stdout | length > 0
